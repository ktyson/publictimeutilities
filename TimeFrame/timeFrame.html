<html>
<head>
<meta charset="utf-8">

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js" type="text/javascript"></script>

<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.0/jquery-ui.min.js" type="text/javascript"></script>
<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/themes/ui-lightness/jquery-ui.css" type="text/css" media="all" />


<script src='spectrum.js'></script>
<link rel='stylesheet' href='spectrum.css' />
    
    
<script>

var weekStartDate = new Date("2014-01-26 00:00:00");
var owner = "kdtyson";
var currColor;
var spans = {};


$(document).ready(function(){
	

    
	makePalette();
	makeFrame();
    makeControls();
    makeEventHandlers();
	

	$(".span").on("hover click", function(){
		
		if(event.which == 1) {
			var id = $(this).attr("id")
			//alert("span " + id);
		
			$(this).css("background-color", currColor);
		
			if(!spans[id]) {
				spans[id] = {};
			} 
			spans[id].color = currColor;
		}
	
	});
	
    $("#control").hide();
	$(".colorspan").on("click", function(){
	
		
		currColor = $(this).css("background-color");
		$("#control").hide();
	
	});
    
    $(".colorspan").on("dblclick", function(){
	
        var color = $(this).css("background-color");
		setEdit(color);	
        $("#control").show();
	
	});
	

});

var timeType = {};
timeType["kdtyson"] = {"choices": {}};
timeType["kdtyson"].choices["#00ff00"] =
		{level_1 : "TRC-Drisco",
		level_2 : "Maintenance",
		level_3 : "General",		
		hidden : false
};
timeType["kdtyson"].choices["#0000ff"] =
		{level_1 : "TRC-Bethel",
		level_2 : "Maintenance",
		level_3 : "General",		
		hidden : false
};
timeType["kdtyson"].choices["#ff0000"] =
		{level_1 : "TT",
		level_2 : "Maintenance",
		level_3 : "General",		
		hidden : false
};

function makePalette() {

	var c = [];
	
	c.push("<table class='palette'><tr>");

		c.push("<td>");
		c.push("<div class='colorspan' title='Erase' style='background-color:white'></div>");		
		c.push("</td>");
	
	for(var color in timeType["kdtyson"].choices) {
        
        var title = timeType["kdtyson"].choices[color].level_1 + "-" + timeType["kdtyson"].choices[color].level_2 + "-" + timeType["kdtyson"].choices[color].level_3;
        
		c.push("<td>");
		c.push("<div title='" + title + "' class='colorspan' style='background-color:" + color + "'></div>");		
		c.push("</td>");
	} 
	
	c.push("</tr></table>");
	
	$("#palette").html(c.join(''));

}
    
function setEdit(color) {
    
    var timeTypeToEdit = timeType["kdtyson"].choices[color];
    
    var L1, L2, L3, Act;
    if(color == "#ffffff") {
        L1 = L2 = L3 = "";
        Act = true;
    } else {
        L1 = timeTypeToEdit.level_1;
        L2 = timeTypeToEdit.level_2;
        L3 = timeTypeToEdit.level_3;
        Act = timeTypeToEdit.active;
    }
    
    
    $("#setColor").spectrum("set", color);
    $("#setLevel1").val(L1);
    $("#setLevel2").val(L2);
    $("#setLevel3").val(L3);
    $("#setActive").prop('checked', Act);
}

function makeFrame() {	

	var c = [];
	
	c.push("<table class='tablespan'>");
	
	c.push("<tr>");
	c.push("<td></td>");
	
	for(var h = 0; h < 24*2; h++) {
						
		//trim hours
		if(Math.abs(24 - h) < 12) {
				
			if(h % 2) {
				c.push("<th>" + "-" + "</th>");
			} else {
				c.push("<th>" + h/2 + "</th>");
			}
		
		}

	}
	c.push("</tr>");
	
	for (var d = 0; d < 7; d++) {
		
		c.push("<tr>");
		
		c.push("<td>" + getDayLabel(d) + "</td>");
		
			for(var h = 0; h < 24*2; h++) {
			
				//trim hours
				if(Math.abs(24 - h) < 12) {
					var id = "d_" + d + "_h_" + h/2;
	
					c.push("<td><div id='" + id + "' class='span'></div></td>");
				}
			}
	
		c.push("</tr>");

	}
	
	c.push("</table>");
	
	$("#calendar").html(c.join(''));
	
	
	$("#display").html(weekStartDate.toString());

}

function getDayLabel(dayNum) {

	var days = ["Su","M","T","W","Th","F","Sa"];
	
	return days[dayNum];
}
    
    
function makeControls() {
    
    var c = [];
    
    c.push("<div>");
    
    c.push("Choose Color: <input type='text' id='setColor' />");
    c.push("  Level 1: <input size='10' id='setLevel1' />");
    c.push("  Level 2: <input size='20' id='setLevel2' />");
    c.push("  Level 3: <input size='30' id='setLevel3' />");
    c.push("  Active: <input type='checkbox' id='setActive' />");
    c.push("<input id='addChoice' type='button' value='Add'></input>");
    c.push("<input id='editChoice' type='button' value='Edit'></input>");
    
    c.push("</div>");
    
    $("#control").html(c.join(''));   
    
    
    $("#setColor").spectrum({
        color: "#ff0000",
        showInput: true,
        preferredFormat: "hex6",
        showButtons: false
    });
    
    c = [];
    
    c.push("<div>");
    
    c.push("<input id='writeReport' type='button' value='Report'></input>");
    c.push("<input id='writeObject' type='button' value='Object'></input>");
    
    c.push("</div>");
    
    $("#reportControl").html(c.join('')); 
    
}
    
function makeEventHandlers() {
    
    $("#writeReport").on("click", function() {
        
        
        
        $("#report").html("test rep");
        
    });

    $("#writeObject").on("click", function() {

        var c = [];
        
        c.push(JSON.stringify(spans));
        c.push(JSON.stringify(timeType));
               
        $("#report").html(c.join("\n\n"));
        
    });
    
    
    $("#addChoice").on("click", function() {
        
        alert($("#setColor").val());
        
    });
    
    
    
    
}

$.cssHooks.backgroundColor = {
    get: function(elem) {
        if (elem.currentStyle)
            var bg = elem.currentStyle["backgroundColor"];
        else if (window.getComputedStyle)
            var bg = document.defaultView.getComputedStyle(elem,
                null).getPropertyValue("background-color");
        if (bg.search("rgb") == -1)
            return bg;
        else {
            bg = bg.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
            function hex(x) {
                return ("0" + parseInt(x).toString(16)).slice(-2);
            }
            return "#" + hex(bg[1]) + hex(bg[2]) + hex(bg[3]);
        }
    }
}





$(function(){
 
  $('.colorspan').hover(function(e){ // Hover event
 
    var titleText = $(this).attr('title');
    
    $(this)
      .data('tiptext', titleText)
      .removeAttr('title');
 
  $('<p class="tooltip"></p>')
    .text(titleText)
    .appendTo('body')
    .css('top', (e.pageY - 10) + 'px')
    .css('left', (e.pageX + 20) + 'px')
    .fadeIn('slow');
 
  }, function(){ // Hover off event
 
    $(this).attr('title', $(this).data('tiptext'));
    $('.tooltip').remove();
 
  }).mousemove(function(e){ // Mouse move event
 
    $('.tooltip')
      .css('top', (e.pageY - 10) + 'px')
      .css('left', (e.pageX + 20) + 'px');
 
 });
 
});
    

</script>

<style>

table.tablespan td {
    background-color: whte;
}

table.tablespan {
    border-collapse: separate;
    border-spacing: 0px;
    *border-collapse: expression('separate', cellSpacing = '10px');
}


.span {
	border: solid thin black;
	width: 20px;
	height: 20px;
}
.colorspan {
	border: solid thin black;
	width: 20px;
	height: 20px;
}
    
    
.tooltip {
    display:none;
    position:absolute;
    border-radius:5px;
    box-shadow:2px 2px 3px rgba(0,0,0,.2);
    background-color:#CCC;
    border:1px solid #F7F7F7;
    text-shadow:-1px -1px 0 #F4F4F4;
    color:#666;
    font:bold italic 16px Tahoma, Geneva, sans-serif;
    padding:10px;
}


</style>

</head>
<body>
<div id="control"></div>
<div id="display"></div>
<div id="palette"></div>
<div id="calendar"></div>
<div id="reportControl"></div>
<div id="report"></div>
</body>
</html>